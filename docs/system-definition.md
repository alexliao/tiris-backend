# Tiris Backend System Definition

## Background
Tiris is a quantitative trading system designed for everyone.  
It enables users to create trading bots that automatically trade cryptocurrency assets on their behalf to generate profits, without requiring expertise in programming or finance.  
The system consists of a series of microservices, applications, and tools, including a website (tiris-portal) which can be extended to cross-platform applications in the future, a backend (tiris-backend), a prediction service (tiris-lib), a trading strategy executor (tiris-bot), a machine learning model training and experiment system (tiris-research), a trading data collector (tiris-dataset), and a strategy backtest system (tiris-backtest).    
Currently, Tiris only supports quantitative trading with cryptocurrencies on mainstream trading such as Binance, Kraken, Gate.io, and others.
Unlike traditional hedge fund firms, Tiris does not collect or custody user assets. Instead, it provides trading bots that operate assets under users' own trading accounts. 
Tiris-backend is a microservice that manages user accounts and trading data generated by tiris-bot. It creates, modifies, and stores data in a database system while providing data for monitoring and presentation on tiris-portal. It is only connected to the two sub systems.

## Tiris-backend Technical Stack
Tiris-backend provides a RESTful API as the service facade for user-facing operations and consumes trading events via NATS message queue for high-frequency trading data. Internally, it uses PostgreSQL as the data storage with TimescaleDB extension for efficiently operating time-series data such as trading logs. NATS JetStream provides reliable message delivery and event processing between tiris-bot and tiris-backend. The programming language is Go (Golang). Deployment uses Docker, with Kubernetes planned for future scaling. Additionally, it will use GitHub, mainstream CI/CD tools, and test-driven development approaches to support the development process.

## Data Structure Definition
The database includes the following core tables:

* **users**: Contains user profile information similar to most user management systems, including username, email, avatar, settings (JSON), and other profile data.

* **exchange_bindings**: Save the binding information for a user with a specific exchange such as Binance, Kraken, Gate.io, Coinbase, etc. Each user can bind multiple exchanges by saving the API key and secret for each particular exchange. The exchange_bindings table includes columns for name, exchange, type(private/public), API key, API secret, and other necessary information, with a user_id column as a foreign key to relate to the users table. user_id can be null for public type of bindings. Some public exchange bindings are pre-created with the system database migration. For example, a binding of {name:"Binance", type:"public", api_key:null, api_secret:null, info:{description:"A virtual Binance exchange for simulation and backtesting"}}

* **tradings**: A trading represents a series of trading activities with exclusive sub accounts. Each user can create multiple tradings. A virtual trading is created for each user by default for simulation trading. Real trading refers to transactions conducted on a specific exchange. The tradings table includes columns for name, type(real/virtual/backtest), and other necessary information, with a user_id column as a foreign key to relate to the users table and an exchange_binding_id as a foreign key to relate to the exchange_bindings table.

* **sub_accounts**: Assets in each trading of a user can be divided into multiple sub-accounts within the Tiris system. For example, if a user has a spot account with 10,000 USDT on Binance, they can create two sub-accounts in the Tiris database: one with 5,000 USDT as the initial balance and another with 3,000 USDT as the initial balance. The user can assign the first sub-account to one trading bot and the second sub-account to another trading bot. These two trading bots will only use their respective 5,000 and 3,000 USDT as initial funds for trading. The remaining 2,000 USDT balance will not be used by the Tiris system at all. Users can manually withdraw funds less than 2,000 USDT from Binance at any time without affecting the operation of Tiris trading bots. The sub_accounts table includes columns for name, symbol, balance, and foreign keys for trading_id and user_id.

* **transactions**: This time-series table records every change in sub-accounts, which is used to calculate, evaluate, and monitor general trading performance metrics such as CAGR, Sharpe ratio, and others. It includes columns for timestamp, direction (debit/credit), reason (such as long, short, stop loss, dividend, transfer, fee, etc.), amount, closing_balance, price (in terms of the quote symbol at transaction time), quote_symbol, and foreign keys for sub_account_id, trading_id, and user_id.

* **trading_logs**: This time-series table records all types of trading logs such as buying, selling, predictions, charting, and other trading activities. It is used to present and monitor the trading process. It includes columns for timestamp, type, source (manual/bot), message (optional), and foreign keys for transaction_id (optional), sub_account_id (optional), trading_id, and user_id.

All tables must contain an id column as the primary key and an info column that stores JSON data for extended and variable information.

## API Definition
The Tiris-backend API includes the following components:

* **User Management**: 
  * Sign in with Google, WeChat OAuth, and other OAuth providers in the future, automatically creating new user records
  * Modify user profiles and settings
  * Disable or remove user accounts by users
  * Query user information

* **Trading Management**:
  * Create a trading by setting the trading type, name, and exchange_binding_id
  * Modify trading configurations
  * Unbind (remove) a trading
  * Query trading information

* **Sub-account Management**:
  * Add a sub-account
  * Delete a sub-account
  * Withdraw funds from a sub-account
  * Deposit funds into a sub-account
  * Modify sub-account information such as name
  * Query sub-account information

* **Trading Log Management**:
  * Add a trading log (via API or NATS message queue)
  * Delete a trading log
  * Query trading log information

* **Transaction Management**:
  Transactions are created within tiris-backend based on trading events from tiris-bot via NATS message queue or direct API calls for trading logs. This ensures reliable processing of high-frequency trading data. The transaction data is read-only for API users.
  * Query transaction information

* **Message Queue Processing**:
  * Consume trading events from tiris-bot via NATS JetStream
  * Process order execution events, balance updates, and trading signals
  * Ensure reliable delivery and ordered processing of trading data
  * Handle event replay and error recovery

## Deployment
Tiris-backend will be packaged as a Docker image based on CentOS 9 and all dependencies the microservice needs. 

## Resources
Use tiris.ai as the base domain for Tiris system.  
Use dev.tiris.ai as the development base domain.















